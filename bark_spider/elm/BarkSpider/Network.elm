-- Functions for requesting simulation execution and results from the server.
-- This implements the HTTP+JSON protocol that the server uses.

module BarkSpider.Network where

import BarkSpider.Simulation.Model exposing (Parameters, Simulation, simulationToJson)
import Http
import Http.Extra exposing (get, post, send, withBody, withHeader)
import Json.Decode
import Json.Decode exposing ((:=))
import Json.Encode
import String
import Task

-- This is what we get back when we request that a simulation be run
type alias RequestResponse =
  { url : String       -- The URL at which the results can be fetched
  , result_id : String -- The ID of the results (append to the url)
  }



-- These are the actual simulation results.
type alias SimulationResults =
  { name : String        -- Name assigned to the results
  , parameters : Parameters  -- Parameters used to calculate the results
  , results : String     -- The results themselves
  }

-- {"results": {"software_development_rate": {"180": "1.7142259919432905", "187": "1.715911766238977", "289": "1.7197934152899481", "212": "1.718731754295767", "86": "1.7963668462764657", "183": "1.715023019735619", "252": "1.7196751513389437", "196": "1.7173547183605955", "208": "1.7184852252825866", "284": "1.7197873190513497", "202": "1.7180062728564118", "114": "1.5548006218919204", "286": "1.7197899465189772", "127": "1.6351058188634728", "192": "1.7167945864014593", "82": "1.793448994063773", "15": "1.3202426894748893", "69": "1.7785364776685937", "68": "1.7769237035679568", "261": "1.7197265895984162", "52": "1.7358923699656614", "72": "1.7829068938845574", "241": "1.7195696892450112", "195": "1.7172252684091915", "20": "1.4308494452459806", "144": "1.6843959425236965", "254": "1.7196887151585298", "255": "1.719694992772467", "108": "1.4953339709602547", "104": "1.4442113528162777", "10": "1.177299447517483", "66": "1.773439039306192", "155": "1.699668320958151", "168": "1.7094725053020403", "175": "1.712592229230909", "147": "1.6894474811144948", "158": "1.7025416365747352", "6": "1.0333966325760826", "242": "1.7195819181546244", "291": "1.7197954483743116", "285": "1.7197886664706459", "193": "1.7169455704532497", "213": "1.7187858799528417", "3": "1.0340966694915015", "92": "1.7997609388582214", "214": "1.7188372993270633", "181": "1.7145054057179894", "99": "1.8026020726305798", "197": "1.7174776958144293", "150": "1.69377854401378", "24": "1.501027247517194", "260": "1.7197219749753185", "140": "1.676329855975021", "80": "1.7917496104926929", "38": "1.6589011956211694", "161": "1.705005145551504", "177": "1.7132963779560288", "225": "1.7192585678860322", "5": "0.9925659718916292", "278": "1.7197776075498958", "134": "1.6606591985039474", "283": "1.7197859007152487", "219": "1.7190583081370463", "300": "1.7198024067339481", "272": "1.7197643962744382", "246": "1.719625017494372", "126": "1.6306474794648522", "65": "1.7715579789759546", "33": "1.6149666085106806", "288": "1.7197923178085106", "107": "1.4835192185140966", "44": "1.6987110538220231", "37": "1.6509918277285618", "63": "1.7674936380962178", "173": "1.7118120090368698", "59": "1.7580002689247722", "166": "1.7083552512209497", "199": "1.7177055115476558", "84": "1.7949826877366735", "16": "1.3446895142801796", "264": "1.7197390946501823", "182": "1.7147708488039535", "93": "1.8002318511943451", "17": "1.367913997845206", "185": "1.71549016638653", "141": "1.6785040765481336", "204": "1.7181825523280454", "112": "1.536973662954888", "167": "1.708928202031765", "151": "1.6950803301849549", "298": "1.7198011253837286", "269": "1.7197561001676025", "119": "1.5921298540868956", "244": "1.719604572209682", "149": "1.6924082427809648", "245": "1.7196150569710615", "128": "1.6393412412921622", "13": "1.2674212951587491", "90": "1.7987434551402803", "31": "1.5939851943673822", "115": "1.5630513041691874", "14": "1.2945091896798464", "71": "1.7815241416900236", "238": "1.7195290034719595", "47": "1.7144665711141045", "251": "1.719667829439032", "164": "1.707117296560461", "227": "1.719312748592278", "34": "1.6246772373641816", "188": "1.7161068912988913", "152": "1.69631702704757", "129": "1.6433648925994178", "250": "1.7196601221759669", "190": "1.7164683604723832", "110": "1.517220799866764", "259": "1.7197171174773211", "28": "1.558187506078361", "292": "1.7197963893274597", "290": "1.7197944578973139", "243": "1.7195935356187566", "22": "1.4677365949286156", "230": "1.719384277717545", "73": "1.7842205084693645", "266": "1.7197464239969231", "74": "1.7854684423249314", "232": "1.7194262017152173", "109": "1.5065579857841054", "103": "1.4297059362572782", "239": "1.7195432666702248", "253": "1.7196821071438602", "257": "1.719706622052285", "55": "1.7463449020427562", "258": "1.7197120043215348", "81": "1.7926210892470926", "189": "1.7162922601058102", "277": "1.7197756780821392", "32": "1.6047448939280482", "171": "1.7109474991265774", "88": "1.7976160493586284", "233": "1.7194456050013198", "102": "1.4144370767214893", "218": "1.7190185208054556", "148": "1.6909658204306335", "98": "1.8022559087910999", "100": "1.8029309282780857", "41": "1.6803345939391467", "281": "1.7197828361663323", "280": "1.7197811818889146", "27": "1.544977417683501", "18": "1.3899772572319804", "226": "1.7192863528635942", "271": "1.7197617714763944", "274": "1.7197692587128144", "210": "1.7186148068926683", "265": "1.7197428532895367", "46": "1.709481696668494", "21": "1.4497659322627166", "198": "1.717594524395571", "62": "1.765299661912824", "29": "1.5707370900534778", "101": "1.3983645929996058", "237": "1.7195139895790486", "125": "1.6259544906241987", "25": "1.5164348444203688", "174": "1.71221212195689", "170": "1.7104808271102254", "56": "1.7494866162196534", "153": "1.6974918890670552", "216": "1.7189325537178082", "131": "1.6508187066461082", "76": "1.7877802397923688", "154": "1.6986080079855659", "205": "1.7182641380835062", "273": "1.7197668898325797", "247": "1.7196344799915169", "268": "1.719753038732357", "123": "1.615814514735807", "248": "1.7196434693638039", "64": "1.7695779154704414", "201": "1.7179111152468929", "156": "1.7006756182821066", "43": "1.6928969416241983", "282": "1.7197844077298794", "51": "1.7320351691438172", "145": "1.6861668587693754", "75": "1.7866539794877196", "58": "1.7553066417323553", "294": "1.7197981324431657", "54": "1.7430378344881274", "224": "1.7192293205412303", "256": "1.7197009565057069", "215": "1.7188861477325736", "209": "1.7185516773903207", "178": "1.7136222724300905", "220": "1.719096106102057", "53": "1.7395567107464134", "297": "1.7198004336966997", "136": "1.666426817724946", "301": "0", "287": "1.7197911625648914", "87": "1.7970074632416775", "221": "1.7191320141688178", "267": "1.7197498161689406", "275": "1.7197715091490369", "42": "1.6867768235212248", "67": "1.775226046619917", "9": "1.1440426191983664", "45": "1.7042344604099577", "194": "1.7170890053024508", "295": "1.7197989391928714", "26": "1.5310720614783853", "146": "1.68784922920277", "270": "1.7197590085310857", "4": "0.9823918360169261", "105": "1.4579914985473275", "116": "1.5708894523325918", "228": "1.7193378245345277", "138": "1.6716320940718974", "60": "1.7605592147575686", "279": "1.7197794405442646", "118": "1.5854096218052973", "222": "1.71916612683224", "186": "1.7157063714390666", "40": "1.6735532996422233", "122": "1.610340843540993", "203": "1.718096672585455", "91": "1.7992652416623014", "78": "1.7898666370067309", "133": "1.6575457738232464", "57": "1.7524712446877053", "36": "1.642666177315292", "184": "1.7152625821207015", "70": "1.7800686130641987", "8": "1.109035431494033", "117": "1.5783356930878252", "48": "1.719202201837434", "234": "1.7194640381231177", "299": "1.7198017824864054", "130": "1.6471873613413106", "249": "1.7196520092674776", "0": "0", "50": "1.7279749577524024", "49": "1.7237010510245974", "179": "1.71393187218045", "113": "1.5461156931790065", "165": "1.7077521451043016", "191": "1.7166356558206273", "229": "1.7193616466796644", "19": "1.4109373536494163", "176": "1.7129533311412266", "160": "1.7042257180838316", "2": "1.088522809991054", "207": "1.7184152756954982", "106": "1.4710826369918242", "12": "1.2389077219786464", "7": "1.0721857602263134", "23": "1.4848087244612196", "217": "1.7189766394037813", "172": "1.711390837542112", "262": "1.7197309734903587", "94": "1.8006792179136628", "276": "1.7197736470634488", "223": "1.719198533862492", "293": "1.7197972832329498", "120": "1.5985140747544146", "159": "1.7034052681178615", "162": "1.7057456016457921", "211": "1.718674779919898", "139": "1.6740412027401659", "132": "1.6542684846856663", "157": "1.7016325507398649", "79": "1.7908322644354293", "39": "1.6664150951191454", "96": "1.801507964761199", "1": "1.1458134842011096", "95": "1.8011042162970148", "200": "1.7178109493421363", "263": "1.719735138187704", "83": "1.7942355036396196", "89": "1.798194206169732", "240": "1.7195568167085764", "11": "1.2088934344206435", "231": "1.7194057772035307", "35": "1.6339023347750072", "137": "1.6690961902105619", "85": "1.7956925126288747", "236": "1.7194981854812474", "61": "1.7629902132987254", "142": "1.6805695860925907", "235": "1.7194815495888254", "111": "1.5273504732452885", "30": "1.5826591948298392", "169": "1.7099895934088025", "143": "1.6825318201598245", "135": "1.6636169519506134", "124": "1.6210145023708793", "97": "1.8018915258021733", "206": "1.7183416445511948", "77": "1.7888501870817852", "163": "1.706449034935366", "121": "1.6045790843885572", "296": "1.7197997056050909"}, "step_number": {"180": "180", "187": "187", "289": "289", "212": "212", "86": "86", "183": "183", "252": "252", "196": "196", "208": "208", "284": "284", "202": "202", "114": "114", "286": "286", "127": "127", "192": "192", "82": "82", "15": "15", "69": "69", "68": "68", "261": "261", "52": "52", "72": "72", "241": "241", "195": "195", "20": "20", "144": "144", "254": "254", "255": "255", "108": "108", "104": "104", "10": "10", "66": "66", "155": "155", "168": "168", "175": "175", "147": "147", "158": "158", "6": "6", "242": "242", "291": "291", "285": "285", "193": "193", "213": "213", "3": "3", "92": "92", "214": "214", "181": "181", "99": "99", "197": "197", "150": "150", "24": "24", "260": "260", "140": "140", "80": "80", "38": "38", "161": "161", "177": "177", "225": "225", "5": "5", "278": "278", "134": "134", "283": "283", "219": "219", "300": "300", "272": "272", "246": "246", "126": "126", "65": "65", "33": "33", "288": "288", "107": "107", "44": "44", "37": "37", "63": "63", "173": "173", "59": "59", "166": "166", "199": "199", "84": "84", "16": "16", "264": "264", "182": "182", "93": "93", "17": "17", "185": "185", "141": "141", "204": "204", "112": "112", "167": "167", "151": "151", "298": "298", "269": "269", "119": "119", "244": "244", "149": "149", "245": "245", "128": "128", "13": "13", "90": "90", "31": "31", "115": "115", "14": "14", "71": "71", "238": "238", "47": "47", "251": "251", "164": "164", "227": "227", "34": "34", "188": "188", "152": "152", "129": "129", "250": "250", "190": "190", "110": "110", "259": "259", "28": "28", "292": "292", "290": "290", "243": "243", "22": "22", "230": "230", "73": "73", "266": "266", "74": "74", "232": "232", "109": "109", "103": "103", "239": "239", "253": "253", "257": "257", "55": "55", "258": "258", "81": "81", "189": "189", "277": "277", "32": "32", "171": "171", "88": "88", "233": "233", "102": "102", "218": "218", "148": "148", "98": "98", "100": "100", "41": "41", "281": "281", "280": "280", "27": "27", "18": "18", "226": "226", "271": "271", "274": "274", "210": "210", "265": "265", "46": "46", "21": "21", "198": "198", "62": "62", "29": "29", "101": "101", "237": "237", "125": "125", "25": "25", "174": "174", "170": "170", "56": "56", "153": "153", "216": "216", "131": "131", "76": "76", "154": "154", "205": "205", "273": "273", "247": "247", "268": "268", "123": "123", "248": "248", "64": "64", "201": "201", "156": "156", "43": "43", "282": "282", "51": "51", "145": "145", "75": "75", "58": "58", "294": "294", "54": "54", "224": "224", "256": "256", "215": "215", "209": "209", "178": "178", "220": "220", "53": "53", "297": "297", "136": "136", "301": "301", "287": "287", "87": "87", "221": "221", "267": "267", "275": "275", "42": "42", "67": "67", "9": "9", "45": "45", "194": "194", "295": "295", "26": "26", "146": "146", "270": "270", "4": "4", "105": "105", "116": "116", "228": "228", "138": "138", "60": "60", "279": "279", "118": "118", "222": "222", "186": "186", "40": "40", "122": "122", "203": "203", "91": "91", "78": "78", "133": "133", "57": "57", "36": "36", "184": "184", "70": "70", "8": "8", "117": "117", "48": "48", "234": "234", "299": "299", "130": "130", "249": "249", "0": "0", "50": "50", "49": "49", "179": "179", "113": "113", "165": "165", "191": "191", "229": "229", "19": "19", "176": "176", "160": "160", "2": "2", "207": "207", "106": "106", "12": "12", "7": "7", "23": "23", "217": "217", "172": "172", "262": "262", "94": "94", "276": "276", "223": "223", "293": "293", "120": "120", "159": "159", "162": "162", "211": "211", "139": "139", "132": "132", "157": "157", "79": "79", "39": "39", "96": "96", "1": "1", "95": "95", "200": "200", "263": "263", "83": "83", "89": "89", "240": "240", "11": "11", "231": "231", "35": "35", "137": "137", "85": "85", "236": "236", "61": "61", "142": "142", "235": "235", "111": "111", "30": "30", "169": "169", "143": "143", "135": "135", "124": "124", "97": "97", "206": "206", "77": "77", "163": "163", "121": "121", "296": "296"}, "elapsed_time": {"180": "180", "187": "187", "289": "289", "212": "212", "86": "86", "183": "183", "252": "252", "196": "196", "208": "208", "284": "284", "202": "202", "114": "114", "286": "286", "127": "127", "192": "192", "82": "82", "15": "15", "69": "69", "68": "68", "261": "261", "52": "52", "72": "72", "241": "241", "195": "195", "20": "20", "144": "144", "254": "254", "255": "255", "108": "108", "104": "104", "10": "10", "66": "66", "155": "155", "168": "168", "175": "175", "147": "147", "158": "158", "6": "6", "242": "242", "291": "291", "285": "285", "193": "193", "213": "213", "3": "3", "92": "92", "214": "214", "181": "181", "99": "99", "197": "197", "150": "150", "24": "24", "260": "260", "140": "140", "80": "80", "38": "38", "161": "161", "177": "177", "225": "225", "5": "5", "278": "278", "134": "134", "283": "283", "219": "219", "300": "300", "272": "272", "246": "246", "126": "126", "65": "65", "33": "33", "288": "288", "107": "107", "44": "44", "37": "37", "63": "63", "173": "173", "59": "59", "166": "166", "199": "199", "84": "84", "16": "16", "264": "264", "182": "182", "93": "93", "17": "17", "185": "185", "141": "141", "204": "204", "112": "112", "167": "167", "151": "151", "298": "298", "269": "269", "119": "119", "244": "244", "149": "149", "245": "245", "128": "128", "13": "13", "90": "90", "31": "31", "115": "115", "14": "14", "71": "71", "238": "238", "47": "47", "251": "251", "164": "164", "227": "227", "34": "34", "188": "188", "152": "152", "129": "129", "250": "250", "190": "190", "110": "110", "259": "259", "28": "28", "292": "292", "290": "290", "243": "243", "22": "22", "230": "230", "73": "73", "266": "266", "74": "74", "232": "232", "109": "109", "103": "103", "239": "239", "253": "253", "257": "257", "55": "55", "258": "258", "81": "81", "189": "189", "277": "277", "32": "32", "171": "171", "88": "88", "233": "233", "102": "102", "218": "218", "148": "148", "98": "98", "100": "100", "41": "41", "281": "281", "280": "280", "27": "27", "18": "18", "226": "226", "271": "271", "274": "274", "210": "210", "265": "265", "46": "46", "21": "21", "198": "198", "62": "62", "29": "29", "101": "101", "237": "237", "125": "125", "25": "25", "174": "174", "170": "170", "56": "56", "153": "153", "216": "216", "131": "131", "76": "76", "154": "154", "205": "205", "273": "273", "247": "247", "268": "268", "123": "123", "248": "248", "64": "64", "201": "201", "156": "156", "43": "43", "282": "282", "51": "51", "145": "145", "75": "75", "58": "58", "294": "294", "54": "54", "224": "224", "256": "256", "215": "215", "209": "209", "178": "178", "220": "220", "53": "53", "297": "297", "136": "136", "301": "301", "287": "287", "87": "87", "221": "221", "267": "267", "275": "275", "42": "42", "67": "67", "9": "9", "45": "45", "194": "194", "295": "295", "26": "26", "146": "146", "270": "270", "4": "4", "105": "105", "116": "116", "228": "228", "138": "138", "60": "60", "279": "279", "118": "118", "222": "222", "186": "186", "40": "40", "122": "122", "203": "203", "91": "91", "78": "78", "133": "133", "57": "57", "36": "36", "184": "184", "70": "70", "8": "8", "117": "117", "48": "48", "234": "234", "299": "299", "130": "130", "249": "249", "0": "0", "50": "50", "49": "49", "179": "179", "113": "113", "165": "165", "191": "191", "229": "229", "19": "19", "176": "176", "160": "160", "2": "2", "207": "207", "106": "106", "12": "12", "7": "7", "23": "23", "217": "217", "172": "172", "262": "262", "94": "94", "276": "276", "223": "223", "293": "293", "120": "120", "159": "159", "162": "162", "211": "211", "139": "139", "132": "132", "157": "157", "79": "79", "39": "39", "96": "96", "1": "1", "95": "95", "200": "200", "263": "263", "83": "83", "89": "89", "240": "240", "11": "11", "231": "231", "35": "35", "137": "137", "85": "85", "236": "236", "61": "61", "142": "142", "235": "235", "111": "111", "30": "30", "169": "169", "143": "143", "135": "135", "124": "124", "97": "97", "206": "206", "77": "77", "163": "163", "121": "121", "296": "296"}}, "parameters": {"interventions": "add 100 10", "assimilation_delay": 20, "training_overhead_proportion": 0.25}, "name": "+10 @ 100d"}

requestResponseDecoder : Json.Decode.Decoder RequestResponse
requestResponseDecoder =
  let
    toResponse url result_id =
      { url = url
      , result_id = result_id
      }
  in
    Json.Decode.object2
      toResponse
      ("url" := Json.Decode.string)
      ("result-id" := Json.Decode.string)

parametersDecoder : Json.Decode.Decoder Parameters
parametersDecoder =
  let
    toParameter a t i =
      { assimilation_delay = a
      , training_overhead_proportion = t
      , interventions = i
      }
  in
    Json.Decode.object3
      toParameter
        ("assimilation_delay" := Json.Decode.int)
        ("training_overhead_proportion" := Json.Decode.float)
        ("interventions" := Json.Decode.string)

simulationResultsDecoder : Json.Decode.Decoder SimulationResults
simulationResultsDecoder =
  let
    toResults name parameters results =
      { name = name
      , parameters = parameters
      , results = results
      }
  in
    Json.Decode.object3
      toResults
      ("name" := Json.Decode.string)
      ("parameters" := parametersDecoder)
      ("results" := Json.Decode.string)

requestSimulation : Simulation -> Task.Task Http.Error RequestResponse
requestSimulation sim =
  let
    -- convertError = flip Task.onError <| Task.succeed << toString
    url = Http.url "/simulate" []
    body = (Http.string (Json.Encode.encode 2 (simulationToJson sim)))
    header = ("Content-Type", "application/json")
  in
    post url
      |> withBody body
      |> withHeader header
      |> send requestResponseDecoder

      -- |> Task.toResult
      -- |> Task.map NewResults
      -- |> Effects.task

requestSimulationResults : RequestResponse -> Task.Task Http.Error SimulationResults
requestSimulationResults reqResponse =
  let
    address = String.concat [reqResponse.url, "/", reqResponse.result_id]
    url = Http.url address []
  in
    get url
      |> send simulationResultsDecoder
